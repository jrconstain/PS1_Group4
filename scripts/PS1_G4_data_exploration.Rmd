---
title: "PS1_G4_Data Exploration"
author: "Juan José Rojas, Francisco Soler, Jesús Yancy y Juan Otalora"
date: "2025-08-31"
output: html_document
---

```{r}
install.packages("pacman")
library(pacman)

p_load(rio, # Import/export data.
       tidyverse, # Tidy-data.
       stargazer, # Descriptive statistics.
       gt, # Descriptive statistics.
       gtsummary,
       caret, # For predictive model assessment.
       gridExtra, # Arrange plots.
       skimr # Summarize data.
       )
```

# Database load and initial cleaning

```{r}
# Working directory setting
username <- Sys.getenv("USERNAME")
# Dynamic filepath
ruta_datos <- file.path("C:/Users", username, "Documents",
                        "MEcA - Uniandes/2025-2/Big Data y Machine Learning/PS1_Group4/data")
# Load original database                  
db <- read_csv(file.path(ruta_datos, "data.csv"))
dim(db) # database dimensions
```
First, we drop all observations with ages < 18. 

```{r}
# Leave observations with age > 18
db <- db |>
  filter(age > 18)
# New database dimensions
dim(db)
# Number and proportion of minors
print((32177-24054)/32177)
```
We lost 25.2% of observations that corresponds to the number of minors, leaving us with 24.054 individuals in the data. 

# Understanding "employment" in the data

```{r}
# Create indicators of hours worked and labor salary income
db <- db |>
  mutate(
    bin_ingLab_m     = ifelse(y_ingLab_m > 0, 1, 0),
    bin_ingLab_m_ha  = ifelse(y_ingLab_m_ha > 0, 1, 0),
    bin_hoursWorked  = ifelse(totalHoursWorked > 0, 1, 0),
    bin_ing_total  = ifelse(ingtot > 0, 1, 0),
  )

# See the distribution of "occupied" and those who have worked the previous week
table(db$dsi) # How many "desempleados" (unmeployed)
table(db$ocu) # How "ocupados" (include independents, "cuenta propia")
table(db$ocu,db$dsi) # All occupied are not unemployed, but not all unoccupied are unemployed

# How it relates with hours workers and income
table(db$bin_hoursWorked, db$ocu) # ocu equivalent to hours worked > 0
table(db$bin_hoursWorked, db$bin_ing_total) # 250 occupied people report 0 income
table(db$bin_hoursWorked, db$bin_ingLab_m_ha) # of the 16397, only 9785 report income from labor

```
There's a huge tension between "income" and "wage". The "ocupados" category do not only include what we could consider employed or "empleados" stricly talking, but also self-employed and unpaid family workers.

As the income of independent and self-employed individuals tends to be more sensitive to external factors, while the wages of strictly employed workers are generally more stable and primarily determined by their individual characteristics and skills, we focus our analysis exclusively on predicting the hourly wages of those who report receiving a salary from employment.

```{r}
# Limit our sample to predict wages from labor
db <- db |>
  filter(bin_ingLab_m_ha == 1)

```

We got 9.785 people left on our study sample. A limited modelation like this would allow us only to predict wages of people who already report some income labor, so we could aim detect subreporting in tax fillings of employed people, but no vulnerable people who could need assistance.

Note: There is a problem: How much people is formally employed? How big a problem is subreporting by formal employed people? 

Note 2: We have difficulties ordering the story, because first we talk about tax fraud but then we want to do inference about age and sex. 

# Characterizing employment

How much of employment is informal? How much it comes from the small businesses (less than 5 employees)?

```{r}
# Factor labels for better reading
db$microEmpresa <- factor(db$microEmpresa, labels = c("No Small", "Small"))
db$informal <- factor(db$informal, labels = c("Formal", "Informal"))

# Informality:
table(db$formal, db$informal)  # check complementary distrib
prop.table(table(db$formal, db$informal)) 
```

22.7% of employment is informal, 77.2% is formal. 

```{r}
# Small businesses role:
table(db$microEmpresa) # count employment from small businesses
prop.table(table(db$microEmpresa)) # 
```

22.5% employment comes from small businesses, 77.4% comes from businesses with more than 5 employees.

```{r}
# Are all small businesses informal?
table(db$microEmpresa, db$informal)
prop.table(table(db$microEmpresa, db$informal)) 
```

Majority of employment comes from formal employment in not-small firm. Only 7% comes from formal in small businesses, and a similarly scarce 7% is informal employment in not-small firms

# Exploring our variables of interest

## Income, wages and hours worked

```{r}
# Create hourly wage from second occupation
db$y_salarySec_m_ha <- db$y_salarySec_m / (db$hoursWorkActualSecondJob * (30 / 7))

table(db$y)
income_vars <- c("ingtot", "y_ingLab_m","y_salary_m", "y_salarySec_m")
                 
wage_vars <- c("y_ingLab_m_ha", "y_salary_m_hu", "y_salarySec_m_ha")
               
hours_vars  <- c("totalHoursWorked", "hoursWorkUsual", "hoursWorkActualSecondJob")
                 
# Explore statistics

# Función general para graficar un conjunto de variables
graficar_variables <- function(df, vars, titulo = "Distribución") {
  # Convertir a formato largo
  df_long <- df %>%
    select(all_of(vars)) %>%
    pivot_longer(cols = everything(), names_to = "variable", values_to = "valor")
  
  # Histograma + densidad
  p1 <- ggplot(df_long, aes(x = valor)) +
    geom_histogram(aes(y = ..density..), bins = 30, fill = "steelblue", color = "white", alpha = 0.6) +
    geom_density(color = "darkred", size = 0.3) +
    facet_wrap(~ variable, scales = "free") +
    labs(title = paste(titulo, "- Histogramas y Densidad")) +
    theme_minimal()
  
  # Boxplots
  p2 <- ggplot(df_long, aes(x = variable, y = valor)) +
    geom_boxplot(fill = "steelblue", outlier.color = "orange") +
    labs(title = paste(titulo, "- Boxplots"), x = "Variable", y = "Valor") +
    theme_minimal() +
    coord_flip()
  
  return(list(histogramas = p1, boxplots = p2))
}

# Ingresos
g_income <- graficar_variables(db, income_vars, "Ingresos")
print(g_income$histogramas)
print(g_income$boxplots)
stargazer(as.data.frame(db[,income_vars]), type="text") 
```
```{r}
# Salarios por hora
g_wage <- graficar_variables(db, wage_vars, "Salarios por hora")
print(g_wage$histogramas)
print(g_wage$boxplots)
stargazer(as.data.frame(db[,wage_vars]), type="text") 
```

```{r}
# Horas trabajadas
g_hours <- graficar_variables(db, hours_vars, "Horas trabajadas")
print(g_hours$histogramas)
print(g_hours$boxplots)
stargazer(as.data.frame(db[,hours_vars]), type="text") 
```

# Characteristics of individuals and jobs

## Creating years of education

Lets start by constructing an approximation to the education level with questions p6210 (which asks for the highest level of education attained) and p6210s1 (which ask about years that were approved). We will count only from elementary school (label p6210=3) to tertiary eduaction (label p6210=6). 

Pseudocode: 

years of education:
  if p6210 = 1, 2, 9 then put 0
  if p6210 = 3, 4, 5 then put the number of p6210s
  if p6210 = 6 then add the number of p6210s + 11 (p.e p6210=6, p6210s1=5 then edu_years = 16)

```{r}
# We see the distribution on 
table(db$p6210s1[db$p6210 == 6])
table(db$p6210s1[db$p6210 == 4])

# Create years of education
db$edu_years <- ifelse(
  db$p6210 %in% c(1, 2, 9), 0,                   # None, Preschool, Unknown → 0
  ifelse(
    db$p6210 %in% c(3, 4, 5), db$p6210s1,        # Primary or Secondary → as is
    ifelse(db$p6210 == 6, db$p6210s1 + 11, NA)   # Tertiary → add 11
  )
)

edu_vars<-c("edu_years", "maxEducLevel", "p6210")
stargazer(as.data.frame(db[,edu_vars]), type="text")
```
## Creating Experience

Experience premium is a well-known phenomenon in labor economics. We follow Fernandez and Messima (2018) to construct a potential experience variable substracting `age-years of education-6`

```{r}
# Create experience var
db <- db %>%
  mutate(exp = age - edu_years - 6)
stargazer(as.data.frame(db[,"exp"]), type="text") # some people have negative experience (not possible)

sum(db$age < db$edu_years + 6, na.rm = TRUE)
inconsistent_age <- db %>%
  filter(age < edu_years + 6) %>%
  select(age, edu_years)  # There are not implausible cases, as some people could be early promoted (31 cases)
stargazer(as.data.frame(inconsistent_age[,"age"]), type="text") 
rm(inconsistent_age)

# We will impute 0 years to those 31 cases as most of them are around 21 years old
db$exp <- ifelse(db$exp < 0, 0, db$exp)
stargazer(as.data.frame(db[,"exp"]), type="text")

# Removing oldest people
youngs <- db %>%
  filter(age <  65) %>%
  select(age, edu_years, exp)
stargazer(as.data.frame(youngs[,"exp"]), type="text")
rm(youngs)
```
## Exploring characteristivs

```{r}
dem_vars <- c("age", "sex", "estrato1", "maxEducLevel", "college", "edu_years", "exp")
                 
ocu_vars <- c("oficio", "relab", "regSalud", "sizeFirm")


g_dem <- graficar_variables(db, dem_vars, "Demographics")
print(g_dem$histogramas)
print(g_dem$boxplots)
stargazer(as.data.frame(db[,dem_vars]), type="text") 

```

```{r}
g_ocu <- graficar_variables(db, ocu_vars, "Job characteristics")
print(g_ocu$histogramas)
print(g_ocu$boxplots)
stargazer(as.data.frame(db[,ocu_vars]), type="text") 
```

```{r}

db <- db|>
  mutate(Log_Total_hour_salary=log(db$y_ingLab_m_ha))

db_clean = db %>% select(Log_Total_hour_salary, ingtot, y_ingLab_m, y_salary_m, y_salarySec_m, y_ingLab_m_ha, y_salary_m_hu, y_salarySec_m_ha, totalHoursWorked, hoursWorkUsual, hoursWorkActualSecondJob, age, sex, estrato1, maxEducLevel, college, edu_years, exp, oficio, relab, formal, microEmpresa, regSalud, sizeFirm, p6240, ocu, dsi)

write.csv(db_clean, file.path(ruta_datos, "db_clean1.csv"), row.names = FALSE)
```