---
title: "gender-earnings-gap"
author: "Juan José Rojas & Francisco Soler"
date: "2025-09-04"
output: html_document
---

```{r}
install.packages("pacman")
library(pacman)

p_load(rio, # Import/export data.
       tidyverse, # Tidy-data.
       stargazer, # Descriptive statistics.
       gt, # Descriptive statistics.
       gtsummary,
       caret, # For predictive model assessment.
       gridExtra, # Arrange plots.
       skimr # Summarize data.
       )
```

# Database load

```{r}
# Working directory setting
username <- Sys.getenv("USERNAME")
# Dynamic filepath
#ruta_datos <- file.path("C:/Users", username, "Documents",
                      #  "MEcA - Uniandes/2025-2/Big Data y Machine Learning/PS1_Group4/data")
# Load original database                  
#db<- read_csv(file.path(ruta_datos, "db_clean1.csv"))
db <- read_csv(file.choose())
dim(db) # database dimensions
```

# Unconditional Gender-Wage GAP

$$ log(w) = β_1 + β_2Female + u $$

```{r}
library(here)
library(readr)

ruta <- here("data", "db_clean1.csv")
db <- read_csv(ruta)
```



```{r}
# Create indicator of female
db <- db |>
  mutate(bin_female = 1 - sex)
db$bin_female <- as.factor(db$bin_female)
class(db$bin_female)
# Run the model 
model_sex <- lm(Log_Total_hour_salary ~ bin_female, data = db)
# View the coefficients
stargazer(model_sex, type = "text")

db <- db %>%
  mutate(across(
    c(bin_female, formal, sizeFirm, relab, oficio),
    ~ as.factor(.)
  ))

```

The unconditional regression indicates that women earn, on average, about 4.7 percent less per hour than men. This gap is estimated without controlling for any observable characteristics, so it reflects the raw difference in average hourly wages between the two groups. In other words, the coefficient captures the unconditional gender wage gap in log-wage terms.

# Equal Pay for Equal Work?

We need to control for: - Similar worker characteristics: Education (edu years, max level, college), age or experience.

-   Similar job characteristics: formality (formal), size of the business (sizeFirm, microEmpresa), occupation (oficio, relab)

$$ log(w) = \beta_1 + \beta_2Female + \beta_3Education + \beta_4Age + \beta_5Age^2 + \beta_5Formality + \beta_6Business Size + \gamma_1Oficio + u $$

$$ log(w) = \beta_1 + \beta_2Female + \beta_3Education + \beta_4Experience + \beta_5Age^2 + \beta_5 + u $$

```{r}
db <- db %>%
  mutate(age2 = age^2)

db$oficio <- factor(db$oficio)
db$formal <- factor(db$formal)
db$microEmpresa <- factor(db$microEmpresa)
db$relab <- factor(db$relab)
  
# Individual characteristics (edu_years + age + age2)
model_equality1 <- lm(Log_Total_hour_salary ~ bin_female + edu_years + age + age2, data = db)

# Individual + Firm nature
model_equality2 <- lm(Log_Total_hour_salary ~ bin_female + edu_years + age + age2 + formal +  sizeFirm + relab, data = db)

# Individual + Firm nature + occupation
model_equality3 <- lm(Log_Total_hour_salary ~ bin_female + edu_years + age + age2 + formal +  sizeFirm + relab + oficio, data = db)

# View the coefficients
stargazer(model_sex, model_equality1, model_equality2, model_equality3, type = "text", digits=7 ,out = "tabla_modelo.txt")

```

```{r}
db %>%
  mutate(sex = factor(sex, levels = c(1,0), labels = c("Men","Women"))) %>%
  select(sex, edu_years, Log_Total_hour_salary, age) %>%
  tbl_summary(by = sex,
              statistic = all_continuous() ~ "{mean} ({sd})",
              digits = all_continuous() ~ 2) %>%
  add_n() %>%           # agrega N por grupo
  add_p()               # prueba de diferencia (opcional)

```

```{R}

#Running the model with FWL to check same results as the above estimations (Model 3)


db$bin_female <- as.numeric(as.character(db$bin_female))
db$Log_Total_hour_salary <- as.numeric(as.character(db$Log_Total_hour_salary))

# Individual + Firm nature + occupation

db<-db %>% mutate(Female3ResidX=lm(bin_female~edu_years + age + age2 + formal +  sizeFirm + relab + oficio,data = db)$residuals) #Residuals of weight~foreign 

db<-db %>% mutate(LogSal3ResidX=lm(Log_Total_hour_salary~edu_years + age + age2 + formal +  sizeFirm + relab + oficio,data = db)$residuals) #Residuals of mpg~foreign 

model_equality3_FWL<-lm(LogSal3ResidX~Female3ResidX,db)
stargazer(model_equality3,model_equality3_FWL,type="text",digits=7)

#Running the model with FWL to check same results as the above estimations (Model 2)


# Individual  + Firm nature

db<-db %>% mutate(Female2ResidX=lm(bin_female~edu_years + age + age2 + formal +  sizeFirm + relab ,data = db)$residuals) #Residuals of weight~foreign 

db<-db %>% mutate(LogSal2ResidX=lm(Log_Total_hour_salary~edu_years + age + age2 + formal +  sizeFirm + relab,data = db)$residuals) #Residuals of mpg~foreign 

model_equality2_FWL<-lm(LogSal2ResidX~Female2ResidX,db)
stargazer(model_equality2,model_equality2_FWL,type="text",digits=7)

#Running the model with FWL to check same results as the above estimations (Model 1)



# Individual

db<-db %>% mutate(FemaleResidX=lm(bin_female~edu_years + age + age2,data = db)$residuals) #Residuals of weight~foreign 

db<-db %>% mutate(LogSalResidX=lm(Log_Total_hour_salary~edu_years + age + age2,data = db)$residuals) #Residuals of mpg~foreign 

model_equality1_FWL<-lm(LogSalResidX~FemaleResidX,db)
stargazer(model_equality1,model_equality1_FWL,type="text",digits=7)




stargazer(model_sex, model_equality1_FWL, model_equality2_FWL, model_equality3_FWL, type="text",digits=7)

#Dado que nos vamos a quedar con 3, corrijo el error estandar, dado que R, no reconoce el numero real de estimadores implicados en FWL:


n <- nrow(db)

# Número de parámetros en el modelo completo (incluye intercepto)
k <- length(coef(model_equality3))

# Varianza-covarianza del modelo FWL
vcov_fwl <- vcov(model_equality3_FWL)

# Corrección por grados de libertad
vcov_fwl_corrected <- vcov_fwl * ((n - 1) / (n - k))

# Error estándar corregido
se_corrected <- sqrt(diag(vcov_fwl_corrected))
se_corrected





```

```{R}

#Sacamos los errores estandar con Bootstrap
p_load("boot")



boot_fwl <- function(data, indices) {
  db <- data[indices, ]
  LogSalBootResidX <- resid(lm(Log_Total_hour_salary~edu_years + age + age2 + formal +  sizeFirm + relab + oficio,data = db))
  FemaleBootResidX <- resid(lm(bin_female~edu_years + age + age2 + formal +  sizeFirm + relab + oficio,data = db))
  coef(lm(LogSalBootResidX ~ FemaleBootResidX ))[2]
}


boot_fwl(db,1:nrow(db))

set.seed(10101)
results <- boot(db, boot_fwl, R = 1000)
results
boot.ci(results, type = "perc")



summary(model_equality3_FWL)

```


```{R}
# ======================================================
# Perfiles y Picos por Género (Edad)
# ======================================================

# --- Perfil edad-salario por género (modelo cuadrático con puntos) ---
ggplot(db, aes(x = age, y = Log_Total_hour_salary , color = as.factor(bin_female))) +
  geom_point(alpha = 0.3, size = 1) +  # puntos de los datos
  geom_smooth(method = "lm", formula = y ~ x + I(x^2), se = TRUE, linewidth = 1) +
  scale_color_manual(values = c("0" = "blue", "1" = "red"), name = "Género") +
  labs(title = "Perfil Edad-Salario por Género (Modelo Cuadrático)",
       x = "Edad (años)", y = "Log(Salario por Hora)") +
  theme_minimal()

model_equality3interaction <- lm(Log_Total_hour_salary ~ bin_female + age + age2 + age*bin_female + age2*bin_female + edu_years + formal +  sizeFirm + relab + oficio, data = db)

# --- Picos por género ---
## Usa tu modelo ya estimado:
fit <- model_equality3interaction

co <- coef(fit)
nm <- names(co)

# Mira los nombres si quieres verificar:
print(nm)

# Helpers: busca el nombre correcto entre varias variantes
pick1 <- function(cands) {
  hit <- intersect(cands, nm)
  if (length(hit) != 1) stop("No se identificó de forma única: ", paste(cands, collapse=", "))
  unname(co[hit])
}

# β2 (age) y β3 (age^2 o I(age^2))
b2 <- pick1(c("age"))
b3 <- pick1(c("age2", "I(age^2)"))

# δ2 (interacción lineal) y δ3 (interacción cuadrática)
# cubre orden y codificación (numérica o factor con '1')
d2 <- pick1(c("age:bin_female","bin_female:age","age:bin_female1","bin_female1:age"))
d3 <- pick1(c("age2:bin_female","bin_female:age2",
              "I(age^2):bin_female","bin_female:I(age^2)",
              "age2:bin_female1","bin_female1:age2",
              "I(age^2):bin_female1","bin_female1:I(age^2)"))

# Picos
a_H <- - b2 / (2*b3)
a_M <- - (b2 + d2) / (2*(b3 + d3))

c(peak_men = a_H, peak_women = a_M)

# ======================================================
# Bootstrap para intervalos de confianza de los picos (Edad)
# ======================================================
calcular_pico_edad <- function(data, indices) {
  d <- data[indices, ]
  fit <- lm(log_wage ~ Edad + Edad2, data = d)
  coefs <- coef(fit)
  return(-coefs["Edad"] / (2 * coefs["Edad2"]))
}

# Bootstrap hombres
set.seed(123)
boot_hombres_edad <- boot(data = subset(geih_modelo, female == "Hombre"), 
                          statistic = calcular_pico_edad, R = 1000)
ci_hombres_edad <- boot.ci(boot_hombres_edad, type = "perc")
cat("IC 95% para el pico de Edad en Hombres:\n")
print(ci_hombres_edad)

# Bootstrap mujeres
set.seed(123)
boot_mujeres_edad <- boot(data = subset(geih_modelo, female == "Mujer"), 
                          statistic = calcular_pico_edad, R = 1000)
ci_mujeres_edad <- boot.ci(boot_mujeres_edad, type = "perc")
cat("IC 95% para el pico de Edad en Mujeres:\n")
print(ci_mujeres_edad)




```

```{r}
fit <- model_equality3


# edad^2: toma "age2" si existe; de lo contrario usa "I(age^2)"
b2 <- coef(fit)["age"]
b3 <- if ("age2" %in% names(coef(fit))) coef(fit)["age2"] else coef(fit)["I(age^2)"]
a_star <- -b2/(2*b3)

# helper: curva promedio por sexo (0 = hombres, 1 = mujeres)
pred_curve <- function(sex_level, ages) {
  sapply(ages, function(a) {
    nd <- transform(
      db,
      bin_female = factor(sex_level, levels = levels(model.frame(fit)$bin_female)),
      age = a,
      age2 = a^2
    )
    mean(exp(predict(fit, newdata = nd)), na.rm = TRUE)
  })
}

# rango de edades y curvas
age_min <- 18
age_max <- ceiling(max(db$age, na.rm = TRUE))
ages    <- seq(age_min, age_max, length.out = 300)

w_m <- pred_curve(0, ages)  # hombres
w_f <- pred_curve(1, ages)  # mujeres

# salarios en la edad pico común
nd_m_star <- transform(db,
  bin_female = factor(0, levels = levels(model.frame(fit)$bin_female)),
  age = a_star, age2 = a_star^2)
nd_f_star <- transform(db,
  bin_female = factor(1, levels = levels(model.frame(fit)$bin_female)),
  age = a_star, age2 = a_star^2)

w_m_star <- mean(exp(predict(fit, newdata = nd_m_star)), na.rm = TRUE)
w_f_star <- mean(exp(predict(fit, newdata = nd_f_star)), na.rm = TRUE)

# data para graficar
curves <- rbind(
  data.frame(age = ages, wage = w_m, group = "Hombres"),
  data.frame(age = ages, wage = w_f, group = "Mujeres")
)
peaks <- rbind(
  data.frame(age = a_star, wage = w_m_star, group = "Hombres"),
  data.frame(age = a_star, wage = w_f_star, group = "Mujeres")
)

# brecha en el pico
gap_abs <- w_m_star - w_f_star
gap_pct <- 100 * (w_m_star / w_f_star - 1)

ggplot(curves, aes(age, wage, linetype = group)) +
  geom_line(color = "black", linewidth = 1) +
  geom_segment(aes(x = a_star, xend = a_star, y = w_f_star, yend = w_m_star),
               color = "grey30", linewidth = 0.7, inherit.aes = FALSE) +
  geom_point(data = peaks, aes(age, wage), shape = 21, size = 2.6,
             fill = "white", color = "black", stroke = 0.7, inherit.aes = FALSE) +
    scale_linetype_manual(NULL, values = c("Hombres" = "solid", "Mujeres" = "dashed")) +
  scale_x_continuous(limits = c(age_min, age_max), breaks = seq(18, age_max, by = 4)) +
  labs(title = "Perfil edad–salario por sexo (modelo con controles)",
       x = "Edad (años)", y = "Salario por hora (niveles)") +
  theme_classic(base_size = 11) +
  theme(plot.title = element_text(face = "bold"),
        axis.title = element_text(face = "bold"),
        legend.position = "top")
```

