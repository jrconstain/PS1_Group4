---
title: "gender-earnings-gap"
author: "Juan José Rojas & Francisco Soler"
date: "2025-09-04"
output: html_document
---

```{r}
library(pacman)

p_load(rio, # Import/export data.
       tidyverse, # Tidy-data.
       stargazer, # Descriptive statistics.
       gt, # Descriptive statistics.
       gtsummary,
       caret, # For predictive model assessment.
       gridExtra, # Arrange plots.
       skimr # Summarize data.
       )
```

# Database load

```{r}
# Working directory setting
username <- Sys.getenv("USERNAME")
# Dynamic filepath
#ruta_datos <- file.path("C:/Users", username, "Documents",
                      #  "MEcA - Uniandes/2025-2/Big Data y Machine Learning/PS1_Group4/data")
# Load original database                  
#db<- read_csv(file.path(ruta_datos, "db_clean1.csv"))
db <- read_csv(file.choose())
dim(db) # database dimensions
```

# Unconditional Gender-Wage GAP

$$ log(w) = β_1 + β_2Female + u $$

```{r}
library(here)
library(readr)

ruta <- here("scripts", "db_clean1.csv")
db <- read_csv(ruta)
```



```{r}
# Create indicator of female
db <- db |>
  mutate(bin_female = 1 - sex)
db$bin_female <- as.factor(db$bin_female)
class(db$bin_female)
# Run the model 
model_sex <- lm(Log_Total_hour_salary ~ bin_female, data = db)
# View the coefficients
stargazer(model_sex, type = "text")

db <- db %>%
  mutate(across(
    c(bin_female, formal, sizeFirm, relab, oficio),
    ~ as.factor(.)
  ))

```

The unconditional regression indicates that women earn, on average, about 4.7 percent less per hour than men. This gap is estimated without controlling for any observable characteristics, so it reflects the raw difference in average hourly wages between the two groups. In other words, the coefficient captures the unconditional gender wage gap in log-wage terms.

# Equal Pay for Equal Work?

We need to control for: - Similar worker characteristics: Education (edu years, max level, college), age or experience.

-   Similar job characteristics: formality (formal), size of the business (sizeFirm, microEmpresa), occupation (oficio, relab)

$$ log(w) = \beta_1 + \beta_2Female + \beta_3Education + \beta_4Age + \beta_5Age^2 + \beta_5Formality + \beta_6Business Size + \gamma_1Oficio + u $$

$$ log(w) = \beta_1 + \beta_2Female + \beta_3Education + \beta_4Experience + \beta_5Age^2 + \beta_5 + u $$

```{r}
db <- db %>%
  mutate(age2 = age^2)

db$oficio <- factor(db$oficio)
db$formal <- factor(db$formal)
db$microEmpresa <- factor(db$microEmpresa)
db$relab <- factor(db$relab)
  
# Individual characteristics (edu_years + age + age2)
model_equality1 <- lm(Log_Total_hour_salary ~ bin_female + edu_years + age + age2, data = db)

# Individual + Firm nature
model_equality2 <- lm(Log_Total_hour_salary ~ bin_female + edu_years + age + age2 + formal +  sizeFirm + relab, data = db)

# Individual + Firm nature + occupation
model_equality3 <- lm(Log_Total_hour_salary ~ bin_female + edu_years + age + age2 + formal +  sizeFirm + relab + oficio, data = db)

# View the coefficients
stargazer(model_sex, model_equality1, model_equality2, model_equality3, type = "text", digits=7 ,out = "tabla_modelo.txt")

```

```{r}
db %>%
  mutate(sex = factor(sex, levels = c(1,0), labels = c("Men","Women"))) %>%
  select(sex, edu_years, Log_Total_hour_salary, age) %>%
  tbl_summary(by = sex,
              statistic = all_continuous() ~ "{mean} ({sd})",
              digits = all_continuous() ~ 2) %>%
  add_n() %>%           # agrega N por grupo
  add_p()               # prueba de diferencia (opcional)

```

```{R}

#Running the model with FWL to check same results as the above estimations (Model 3)


db$bin_female <- as.numeric(as.character(db$bin_female))
db$Log_Total_hour_salary <- as.numeric(as.character(db$Log_Total_hour_salary))

# Individual + Firm nature + occupation

db<-db %>% mutate(Female3ResidX=lm(bin_female~edu_years + age + age2 + formal +  sizeFirm + relab + oficio,data = db)$residuals) #Residuals of weight~foreign 

db<-db %>% mutate(LogSal3ResidX=lm(Log_Total_hour_salary~edu_years + age + age2 + formal +  sizeFirm + relab + oficio,data = db)$residuals) #Residuals of mpg~foreign 

model_equality3_FWL<-lm(LogSal3ResidX~Female3ResidX,db)
stargazer(model_equality3,model_equality3_FWL,type="text",digits=7)

#Running the model with FWL to check same results as the above estimations (Model 2)


# Individual  + Firm nature

db<-db %>% mutate(Female2ResidX=lm(bin_female~edu_years + age + age2 + formal +  sizeFirm + relab ,data = db)$residuals) #Residuals of weight~foreign 

db<-db %>% mutate(LogSal2ResidX=lm(Log_Total_hour_salary~edu_years + age + age2 + formal +  sizeFirm + relab,data = db)$residuals) #Residuals of mpg~foreign 

model_equality2_FWL<-lm(LogSal2ResidX~Female2ResidX,db)
stargazer(model_equality2,model_equality2_FWL,type="text",digits=7)

#Running the model with FWL to check same results as the above estimations (Model 1)



# Individual

db<-db %>% mutate(FemaleResidX=lm(bin_female~edu_years + age + age2,data = db)$residuals) #Residuals of weight~foreign 

db<-db %>% mutate(LogSalResidX=lm(Log_Total_hour_salary~edu_years + age + age2,data = db)$residuals) #Residuals of mpg~foreign 

model_equality1_FWL<-lm(LogSalResidX~FemaleResidX,db)
stargazer(model_equality1,model_equality1_FWL,type="text",digits=7)




stargazer(model_sex, model_equality1_FWL, model_equality2_FWL, model_equality3_FWL, type="text",digits=7)

#Dado que nos vamos a quedar con 3, corrijo el error estandar, dado que R, no reconoce el numero real de estimadores implicados en FWL:


n <- nrow(db)

# Número de parámetros en el modelo completo (incluye intercepto)
k <- length(coef(model_equality3))

# Varianza-covarianza del modelo FWL
vcov_fwl <- vcov(model_equality3_FWL)

# Corrección por grados de libertad
vcov_fwl_corrected <- vcov_fwl * ((n - 1) / (n - k))

# Error estándar corregido
se_corrected <- sqrt(diag(vcov_fwl_corrected))
se_corrected





```

```{R}

#Sacamos los errores estandar con Bootstrap
p_load("boot")



boot_fwl <- function(data, indices) {
  db <- data[indices, ]
  LogSalBootResidX <- resid(lm(Log_Total_hour_salary~edu_years + age + age2 + formal +  sizeFirm + relab + oficio,data = db))
  FemaleBootResidX <- resid(lm(bin_female~edu_years + age + age2 + formal +  sizeFirm + relab + oficio,data = db))
  coef(lm(LogSalBootResidX ~ FemaleBootResidX ))[2]
}


boot_fwl(db,1:nrow(db))

set.seed(10101)
results <- boot(db, boot_fwl, R = 1000)
results
boot.ci(results, type = "perc")



summary(model_equality3_FWL)

```


```{R}
# Perfiles y Picos por Género (Edad) modelo con controles

model_equality3interaction <- lm(Log_Total_hour_salary ~ bin_female + age + age2 + age*bin_female + age2*bin_female + edu_years + formal +  sizeFirm + relab + oficio, data = db)

# Picos por género
fit <- model_equality3interaction

co <- coef(fit)
nm <- names(co)

#Busca el nombre correcto entre varias variantes
pick1 <- function(cands) {
  hit <- intersect(cands, nm)
  if (length(hit) != 1) stop("No se identificó de forma única: ", paste(cands, collapse=", "))
  unname(co[hit])
}

# β2 (age) y β3 (age^2 o I(age^2))
b2 <- pick1(c("age"))
b3 <- pick1(c("age2", "I(age^2)"))

# δ2 (interacción lineal) y δ3 (interacción cuadrática)
d2 <- pick1(c("age:bin_female","bin_female:age","age:bin_female1","bin_female1:age"))
d3 <- pick1(c("age2:bin_female","bin_female:age2",
              "I(age^2):bin_female","bin_female:I(age^2)",
              "age2:bin_female1","bin_female1:age2",
              "I(age^2):bin_female1","bin_female1:I(age^2)"))

# Picos
a_H <- - b2 / (2*b3)
a_M <- - (b2 + d2) / (2*(b3 + d3))

c(peak_men = a_H, peak_women = a_M)

```

```{r}
library(ggplot2)
library(scales)

fit <- model_equality3interaction
mf  <- model.frame(fit)

# Rango y grid
age_min <- max(18, floor(min(mf$age, na.rm=TRUE)))
age_max <- ceiling(max(mf$age, na.rm=TRUE))
ages    <- seq(age_min, age_max, length.out = 300)

# Fila de referencia (medias/moda)
most_common <- function(x) names(sort(table(x), decreasing=TRUE))[1]
ref_row <- as.data.frame(lapply(mf, function(x)
  if (is.numeric(x)) mean(x, na.rm=TRUE) else factor(most_common(x), levels=levels(x))
))[1,,drop=FALSE]

# Grids por sexo (factor 2 niveles o 0/1)
if (is.factor(mf$bin_female)) { lev <- levels(mf$bin_female); male <- lev[1]; female <- lev[2]
  make_grid <- function(sex) { nd <- ref_row[rep(1, length(ages)),,drop=FALSE]
    nd$age <- ages; if ("age2"%in%names(nd)) nd$age2 <- ages^2
    nd$bin_female <- factor(sex, levels=lev); nd }
} else { male <- 0; female <- 1
  make_grid <- function(sex) { nd <- ref_row[rep(1, length(ages)),,drop=FALSE]
    nd$age <- ages; if ("age2"%in%names(nd)) nd$age2 <- ages^2
    nd$bin_female <- sex; nd }
}
grid_m <- make_grid(male); grid_f <- make_grid(female)

# Predicciones (log) -> niveles + IC 95%
crit <- qnorm(0.975)
to_levels <- function(pr) data.frame(fit=exp(pr$fit),
                                     lwr=exp(pr$fit-crit*pr$se.fit),
                                     upr=exp(pr$fit+crit*pr$se.fit))
pm <- predict(fit, newdata=grid_m, se.fit=TRUE)
pf <- predict(fit, newdata=grid_f, se.fit=TRUE)
plot_data <- rbind(
  cbind(age=ages, to_levels(pm), group="Hombres"),
  cbind(age=ages, to_levels(pf), group="Mujeres")
)

# Picos (con interacciones)
co <- coef(fit); nm <- names(co)
b2 <- unname(co["age"])
b3 <- unname(co[intersect(c("age2","I(age^2)"), nm)][1])
d2 <- unname(co[intersect(c("age:bin_female","bin_female:age","age:bin_female1","bin_female1:age"), nm)][1])
d3 <- unname(co[intersect(c("age2:bin_female","bin_female:age2","I(age^2):bin_female","bin_female:I(age^2)",
                            "age2:bin_female1","bin_female1:age2","I(age^2):bin_female1","bin_female1:I(age^2)"), nm)][1])
v_m <- max(age_min, min(age_max, - b2/(2*b3)))
v_f <- max(age_min, min(age_max, - (b2 + d2)/(2*(b3 + d3))))

# Puntos crudos en niveles, color por sexo (sin afectar eje-Y)
db_pts <- transform(
  db,
  group = if (is.factor(bin_female)) factor(bin_female, labels=c("Hombres","Mujeres"))
          else factor(bin_female, levels=c(0,1), labels=c("Hombres","Mujeres")),
  wage  = exp(Log_Total_hour_salary)
)

# Tope del eje-Y tomado de las curvas (no de los puntos)
y_cap <- max(quantile(plot_data$upr, 0.999, na.rm=TRUE)) * 1.2

# grafico
cols <- c("Hombres"="#274C77","Mujeres"="#EF6351")
p <- ggplot(plot_data, aes(age, fit, color=group, linetype=group)) +
  geom_ribbon(aes(ymin=lwr, ymax=upr, fill=group), alpha=0.20, colour=NA, show.legend=FALSE) +
  geom_point(data=db_pts, aes(age, wage, color=group),
             alpha=0.5, size=0.7, stroke=0.4, inherit.aes=FALSE,
             position=position_jitter(width=0.25, height=0), na.rm=TRUE) +
  geom_line(linewidth=1.2) +
  geom_vline(xintercept=v_m, linetype="dashed", color=cols["Hombres"], show.legend=FALSE) +
  geom_vline(xintercept=v_f, linetype="dashed", color=cols["Mujeres"],  show.legend=FALSE) +
  coord_cartesian(ylim=c(0, y_cap)) +
  scale_color_manual(NULL, values=cols) +
  scale_fill_manual(NULL,  values=cols) +
  scale_linetype_manual(NULL, values=c("Hombres"="solid","Mujeres"="solid")) +
  scale_y_continuous(labels=label_number(big.mark=",")) +
  labs(title="Age-Wage Profile by sex (Fit with controls)",
       x="Age", y="Hourly Wage (Levels)") +
  theme_classic(base_size=12) +
  theme(plot.title=element_text(face="bold"),
        axis.title=element_text(face="bold"),
        legend.position="top")

p

ggsave("perfil_edad_salario_controles.jpg", plot = p,
       width = 8, height = 4.4,
       dpi = 600)

```

```{r}
# Perfiles y Picos por Género (Edad) modelo con controles

model_edad_sex <- lm(Log_Total_hour_salary ~ bin_female + age + age2 + age*bin_female + age2*bin_female, data = db)

# Picos por género
fit12 <- model_edad_sex

co12 <- coef(fit12)
nm12 <- names(co12)

#Buscar el nombre correcto entre varias variantes
pick12 <- function(cands12) {
  hit12 <- intersect(cands12, nm12)
  if (length(hit12) != 1) stop("No se identificó de forma única: ", paste(cands12, collapse=", "))
  unname(co12[hit12])
}

# β2 (age) y β3 (age^2 o I(age^2))
b212 <- pick12(c("age"))
b312 <- pick12(c("age2", "I(age^2)"))

# δ2 (interacción lineal) y δ3 (interacción cuadrática)
d212 <- pick12(c("age:bin_female","bin_female:age","age:bin_female1","bin_female1:age"))
d312 <- pick12(c("age2:bin_female","bin_female:age2",
              "I(age^2):bin_female","bin_female:I(age^2)",
              "age2:bin_female1","bin_female1:age2",
              "I(age^2):bin_female1","bin_female1:I(age^2)"))

# Picos
a_H12 <- - b212 / (2*b312)
a_M12 <- - (b212 + d212) / (2*(b312 + d312))

c(peak_men12 = a_H12, peak_women12 = a_M12)

```

```{r}
# Modelo sin controles
fit <- model_edad_sex
mf  <- model.frame(fit)

# Rango y grid
age_min <- max(18, floor(min(mf$age, na.rm = TRUE)))
age_max <- ceiling(max(mf$age, na.rm = TRUE))
ages    <- seq(age_min, age_max, length.out = 300)

# Fila de referencia (medias/moda)
most_common <- function(x) names(sort(table(x), decreasing = TRUE))[1]
ref_row <- as.data.frame(lapply(mf, function(x)
  if (is.numeric(x)) mean(x, na.rm = TRUE) else factor(most_common(x), levels = levels(x))
))[1, , drop = FALSE]

# Grids por sexo (factor con 2 niveles o 0/1)
if (is.factor(mf$bin_female)) {
  lev <- levels(mf$bin_female); male <- lev[1]; female <- lev[2]
  make_grid <- function(sex) {
    nd <- ref_row[rep(1, length(ages)), , drop = FALSE]
    nd$age <- ages; if ("age2" %in% names(nd)) nd$age2 <- ages^2
    nd$bin_female <- factor(sex, levels = lev); nd
  }
} else {
  male <- 0; female <- 1
  make_grid <- function(sex) {
    nd <- ref_row[rep(1, length(ages)), , drop = FALSE]
    nd$age <- ages; if ("age2" %in% names(nd)) nd$age2 <- ages^2
    nd$bin_female <- sex; nd
  }
}
grid_m <- make_grid(male)
grid_f <- make_grid(female)

# predict
crit <- qnorm(0.975)
to_levels <- function(pr) data.frame(
  fit = exp(pr$fit),
  lwr = exp(pr$fit - crit*pr$se.fit),
  upr = exp(pr$fit + crit*pr$se.fit)
)
pm <- predict(fit, newdata = grid_m, se.fit = TRUE)
pf <- predict(fit, newdata = grid_f, se.fit = TRUE)
plot_data <- rbind(
  cbind(age = ages, to_levels(pm), group = "Hombres"),
  cbind(age = ages, to_levels(pf), group = "Mujeres")
)

# Picos
co <- coef(fit); nm <- names(co)
b2 <- unname(co["age"])
b3 <- unname(co[intersect(c("age2","I(age^2)"), nm)][1])
d2 <- unname(co[intersect(c("age:bin_female","bin_female:age","age:bin_female1","bin_female1:age"), nm)][1])
d3 <- unname(co[intersect(c("age2:bin_female","bin_female:age2",
                            "I(age^2):bin_female","bin_female:I(age^2)",
                            "age2:bin_female1","bin_female1:age2",
                            "I(age^2):bin_female1","bin_female1:I(age^2)"), nm)][1])
v_m <- max(age_min, min(age_max, - b2/(2*b3)))
v_f <- max(age_min, min(age_max, - (b2 + d2)/(2*(b3 + d3))))

# Puntos crudos en niveles, color por sexo
db_pts <- transform(
  db,
  group = if (is.factor(bin_female)) factor(bin_female, labels = c("Hombres","Mujeres"))
          else factor(bin_female, levels = c(0,1), labels = c("Hombres","Mujeres")),
  wage  = exp(Log_Total_hour_salary)
)

# Tope del eje-Y basado en las curvas (no los puntos)
y_cap <- max(quantile(plot_data$upr, 0.999, na.rm = TRUE)) * 1.02

# grafico
cols <- c("Hombres"="#274C77","Mujeres"="#EF6351")
p2 <- ggplot(plot_data, aes(age, fit, color = group)) +  # líneas sólidas para ambos
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = group),
              alpha = 0.20, colour = NA, show.legend = FALSE) +
  geom_point(data = db_pts, aes(age, wage, color = group),
             alpha = 0.5, size = 0.7, stroke = 0.4, inherit.aes = FALSE,
             position = position_jitter(width = 0.25, height = 0), na.rm = TRUE) +
  geom_line(linewidth = 1.2) +
  geom_vline(xintercept = v_m, linetype = "dashed", color = cols["Hombres"], show.legend = FALSE) +
  geom_vline(xintercept = v_f, linetype = "dashed", color = cols["Mujeres"],  show.legend = FALSE) +
  coord_cartesian(ylim = c(0, y_cap)) +
  scale_color_manual(NULL, values = cols) +
  scale_fill_manual(NULL,  values = cols) +
  scale_y_continuous(labels = scales::label_number(big.mark = ",")) +
  labs(title = "Age–Wage Profile by Sex (No controls)",
       x = "Age", y = "Hourly Wage (levels)") +
  theme_classic(base_size = 12) +
  theme(plot.title = element_text(face = "bold"),
        axis.title  = element_text(face = "bold"),
        legend.position = "top")

ggsave("perfil_edad_salario_nocontroles.jpg", plot = p2,
       width = 8, height = 4.4,
       dpi = 600)


p2
```


```{r}
library(boot)

peak_fn <- function(data, index) {
  d <- data[index, , drop = FALSE]

  # Asegura levels consistentes en cada réplica
  if (!is.factor(d$bin_female)) d$bin_female <- factor(d$bin_female, levels = c(0,1))

  fit <- lm(Log_Total_hour_salary ~ bin_female + age + age2 +
              age*bin_female + age2*bin_female +
              edu_years + formal + sizeFirm + relab + oficio,
            data = d)

  co <- coef(fit); nm <- names(co)

  pick1 <- function(cands) {
    hit <- intersect(cands, nm)
    if (length(hit) < 1) stop("No se encontró coef para: ", paste(cands, collapse=", "))
    unname(co[hit[1]])
  }

  # β2 y β3
  b2 <- pick1(c("age"))
  b3 <- pick1(c("age2", "I(age^2)"))

  # δ2 y δ3
  d2 <- pick1(c("age:bin_female","bin_female:age","age:bin_female1","bin_female1:age"))
  d3 <- pick1(c("age2:bin_female","bin_female:age2",
                "I(age^2):bin_female","bin_female:I(age^2)",
                "age2:bin_female1","bin_female1:age2",
                "I(age^2):bin_female1","bin_female1:I(age^2)"))

  a_H <- - b2 / (2*b3)
  a_M <- - (b2 + d2) / (2*(b3 + d3))

  c(peak_men = a_H, peak_women = a_M)   # <-- devolver ambos
}

# Prueba en muestra original
peak_fn(db, 1:nrow(db))

# Bootstrap
set.seed(123)
boot_out <- boot(db, statistic = peak_fn, R = 1000)

# Resultados
boot_out$t0                        # c(peak_men, peak_women)
boot.ci(boot_out, type = "perc", index = 1)  # IC hombres
boot.ci(boot_out, type = "perc", index = 2)  # IC mujeres
```

```{r}

model_equality4interaction <- lm(Log_Total_hour_salary ~ bin_female + age + age2 + age*bin_female + age2*bin_female, data = db)

# picos con el modelo nueno
fit <- model_equality4interaction
co  <- coef(fit); nm <- names(co)

pick1 <- function(cands) {
  hit <- intersect(cands, nm)
  if (length(hit) < 1) stop("no encontré: ", paste(cands, collapse=", "))
  unname(co[hit[1]])
}

b2 <- pick1(c("age"))
b3 <- pick1(c("age2","I(age^2)"))
d2 <- pick1(c("age:bin_female","bin_female:age","age:bin_female1","bin_female1:age"))
d3 <- pick1(c("age2:bin_female","bin_female:age2",
              "I(age^2):bin_female","bin_female:I(age^2)",
              "age2:bin_female1","bin_female1:age2",
              "I(age^2):bin_female1","bin_female1:I(age^2)"))

c(peak_men   = - b2 / (2*b3),
  peak_women = - (b2 + d2) / (2*(b3 + d3)))
```

```{r}
# Bootstrap (sin controles)
peak_fn <- function(data, index) {
  d <- data[index, , drop = FALSE]
  if (!is.factor(d$bin_female)) d$bin_female <- factor(d$bin_female, levels = c(0,1))

  fit <- lm(
    Log_Total_hour_salary ~ bin_female + age + age2 +
      age*bin_female + age2*bin_female,
    data = d
  )

  co <- coef(fit); nm <- names(co)
  pick1 <- function(cands) { h <- intersect(cands, nm); if (!length(h)) stop("faltan: ", paste(cands, collapse=", ")); unname(co[h[1]]) }

  b2 <- pick1(c("age"))
  b3 <- pick1(c("age2","I(age^2)"))
  d2 <- pick1(c("age:bin_female","bin_female:age","age:bin_female1","bin_female1:age"))
  d3 <- pick1(c("age2:bin_female","bin_female:age2",
                "I(age^2):bin_female","bin_female:I(age^2)",
                "age2:bin_female1","bin_female1:age2",
                "I(age^2):bin_female1","bin_female1:I(age^2)"))

  c(peak_men   = - b2/(2*b3),
    peak_women = - (b2 + d2)/(2*(b3 + d3)))
}

# Prueba en muestra original
peak_fn(db, 1:nrow(db))

set.seed(123)
boot_out <- boot(db, statistic = peak_fn, R = 1000)

boot_out$t0
boot.ci(boot_out, type = "perc",  index = 1)  # IC hombres
boot.ci(boot_out, type = "perc",  index = 2)  # IC mujeres
```


