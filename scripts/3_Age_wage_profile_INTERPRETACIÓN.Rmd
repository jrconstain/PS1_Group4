---
title: "Age-wage profile"
author: "Jesús Yancy - Juan Otalora"
date: "2025-09-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Set working directory
username <- Sys.getenv("USER")

if (username == "jesusyancy"){
  path <- "/Users/jesusyancy/Documents/MECA/BDML/TALLERES/TALLER 1"
} else if(username == ''){
  path <- ""
}
setwd(path)
```

```{r}
library(pacman)
```

```{r}
# Instalar paquetes
p_load(rio, # import/export data
       tidyverse, # tidy-data
       skimr, # summary data
       visdat, # visualizing missing data
       corrplot, # Correlation Plots 
       stargazer) # tables/output to TEX.
```

```{r}
df <- import("https://raw.githubusercontent.com/jrconstain/PS1_Group4/refs/heads/main/data/db_clean.csv?token=GHSAT0AAAAAADKRAEXTFIOTMHF33P6AI2E42FZ7WNA")
```

## 3. Age-wage profile.

A great deal of evidence in labor economics suggests that the typical worker’s age-wage profile has a predictable path: “Wages tend to be low when the worker is young; they rise as the worker ages, peaking at about age 50; and the wage rate tends to remain stable or decline slightly after age 50”.

In this subsection we are going to estimate the Age-wage profile profile for the individuals in this sample:

$$ log(w) = β_1 + β_2Age+ β_3Age^2 + u $$

```{r}
df <- df %>%
  mutate(age2 = age^2)
```

```{r}
model_age <- lm(Log_Total_hour_salary ~ age + age2, data = df)

stargazer(model_age, type = "text")
```
### Resultados de la regresión

La estimación del perfil edad–salario muestra un coeficiente positivo para la edad (0.065) y un coeficiente negativo para la edad al cuadrado (-0.00072), ambos estadísticamente significativos al 1%. Esto implica que los salarios horarios aumentan con la edad, pero a un ritmo decreciente, confirmando la forma cóncava predicha por la teoría de capital humano. El intercepto (7.426) no tiene una interpretación económica directa, pero permite ajustar la curva al nivel de los datos.
Peak age

```{r}
# Extraer coeficientes
coefs <- coef(model_age)
b2 <- coefs["age"]
b3 <- coefs["age2"]

peak_age <- -b2 / (2 * b3)
peak_age

peak_salary <- coefs["(Intercept)"] + b2*peak_age + b3*peak_age^2
exp(peak_salary)

```
### Significancia y efectos marginales

La significancia estadística de los coeficientes respalda que la edad es un determinante relevante de los ingresos laborales. El efecto marginal de un año adicional sobre el salario (en logaritmos) es positivo a edades tempranas y se reduce con la edad: a los 20 años el aumento esperado es cercano al 3.6%, a los 30 años al 2.2%, a los 40 años al 0.8%, y se acerca a cero en torno a los 45 años, punto en el cual los salarios dejan de crecer. Después de esa edad, el retorno marginal se vuelve negativo.

### Ajuste in-sample

El R² del modelo es 0.039, lo que significa que la edad y su cuadrado explican alrededor del 4% de la variación en los salarios horarios. Aunque este ajuste es bajo, es lo esperado en un modelo que incluye únicamente la edad como regresor. Sin embargo, es suficiente para capturar la trayectoria general de los salarios a lo largo de la vida laboral.

### Edad pico

La edad de pico estimada es de 45.3 años, lo que significa que a esa edad se alcanza el salario horario promedio máximo en la muestra. El valor estimado del salario en el pico es de aproximadamente 7,249 en las unidades de la variable salarial. A partir de ese punto, la trayectoria salarial se estabiliza o decrece levemente, en línea con lo planteado por la literatura de Mincer (1974) sobre la depreciación del capital humano en etapas avanzadas de la vida laboral.
```{r}
library(ggplot2)

# Coeficientes del modelo original
coefs <- coef(model_age)
b1 <- coefs["(Intercept)"]
b2 <- coefs["age"]
b3 <- coefs["age2"]

# Peak age estimado
peak_age <- -b2 / (2 * b3)
peak_salary <- b1 + b2*peak_age + b3*peak_age^2

# Crear un rango de edades para graficar la curva
age_seq <- seq(min(df$age, na.rm = TRUE), max(df$age, na.rm = TRUE), length.out = 200)
pred_salary <- b1 + b2*age_seq + b3*age_seq^2

# Dataframe para graficar
plot_data <- data.frame(age = age_seq, salary = pred_salary)


# 4) Gráfico
library(ggplot2)

# 1) Chequear que existe 'age'
if (!"age" %in% names(df)) stop("No existe 'age' en df (si se llama 'edad': df$age <- df$edad)")
df$age <- suppressWarnings(as.numeric(df$age))

# 2) Definir límites fijos del eje X
age_min <- 18
age_max <- floor(max(df$age, na.rm = TRUE))

# 3) Grid de edades y predicciones
age_grid <- data.frame(age = seq(age_min, age_max, by = 1))
pred <- predict(model_age, newdata = transform(age_grid, age2 = age^2), se.fit = TRUE)
plot_df <- transform(age_grid,
                     fit = as.numeric(pred$fit),
                     lo  = as.numeric(pred$fit - 1.96*pred$se.fit),
                     hi  = as.numeric(pred$fit + 1.96*pred$se.fit))

# 4) Calcular edad pico
coefs <- coef(model_age)
b1 <- coefs["(Intercept)"]; b2 <- coefs["age"]; b3 <- coefs["age2"]
peak_age <- -b2/(2*b3)
peak_y   <- b1 + b2*peak_age + b3*peak_age^2

# 5) Ajuste eje Y para ver concavidad
rng <- range(plot_df$fit, na.rm = TRUE)
y_min_fix <- min(plot_df$lo, na.rm = TRUE) - 0.35*diff(rng)
y_max_fix <- max(plot_df$hi, na.rm = TRUE) + 0.08 *diff(rng)

# 6) Dibujar ÚNICA gráfica
ggplot(plot_df, aes(x = age, y = fit)) +
  geom_ribbon(aes(ymin = lo, ymax = hi), fill = "#CFE8FF", alpha = 0.6) +
  geom_line(linewidth = 1.6, color = "#006EDB") +
  geom_vline(xintercept = peak_age, linetype = "dashed", color = "#D81B60", linewidth = 1) +
  geom_point(aes(x = peak_age, y = peak_y), color = "#D81B60", size = 3.6) +
  labs(
    title    = "Perfil edad–salario estimado",
    subtitle = paste0("Edad pico ≈ ", round(peak_age, 1), " años"),
    x = "Edad (años)",
    y = "Log salario por hora"
  ) +
  scale_x_continuous(limits = c(age_min, age_max),
                     breaks = seq(18, age_max, by = 5),
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(y_min_fix, y_max_fix),
                     expand = c(0, 0.01)) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title    = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(color = "#555"),
    axis.title    = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )


```
## AGE-WAGE PROFILE

La figura muestra el perfil edad–salario estimado: los ingresos aumentan rápidamente en edades tempranas, alcanzan su máximo alrededor de los 45 años (línea y punto rojos) y luego tienden a estabilizarse o caer levemente. La forma cóncava confirma la teoría de capital humano y las bandas de confianza indican mayor precisión en edades intermedias que en los extremos.


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
